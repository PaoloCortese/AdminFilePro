<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#007aff">
    <title>AdminFilePro</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkFkbWluRmlsZVBybyIsCiAgInNob3J0X25hbWUiOiAiRmlsZVBybyIsCiAgImRlc2NyaXB0aW9uIjogIkdlc3Rpb25lIHByb2Zlc3Npb25hbGUgZGViaXRpIGFnZW56aWUiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y5ZjlmYiIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDdhZmYiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFBQUlBQUFBQ0FDQVlBQUFENEJBQUFBIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwwAADsMBx2+oZAAAABZ0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMS42/U4J6AAABGdJREFUeF7t3D1oFVEQBuCNiIJYWFhYiI2FhYWFhYVYWIiFhYVYWFgIFoKFYCFYCBaChWAhWAgWgoVgIVgIFoKF4g4VgIVgIVgI/uAvzpnce3Pv3t2zZ3fO7p73wEcSk5vMzHdmzpzdu+8VgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgnHHwsLCFLF7fn5+p9gz+f+/giAYY0gCrCC2EzuJLcRmsUlsI7FZbJPYLraLWPCAwRhiZmZmJbGH+EZ8Jr4Q74m3xGviJfGceEI8JO4R14lzxAFiD7GO6HQiZCGBDKcR54mbxEPiGfGaeEt8ID4TX4kfRA8TIQsJZLgmcYQ4R1wl7hJPidfEO+Ij8YX4RvwgehgEWUggw3WJY8Ql4jbxmHhFvCXeE5+Ir8R3oodBkIUEMlyf2E+cJK4Qt4gnxEviDfGO+EB8Jr4SP4geBkEWEshwI2I3cZQ4T1wjbhOPiZfEa+It8Z74RHwhvhE9DIIsJJDhpsQu4ghxlrhM3CQeEs+JV8Qb4h3xgfhMfCV+ED0MgiwkkOFY4ghxlrhE3CAeEE+JF8Qr4g3xjnhPfCQ+E1+J70QPgyALCWS4FbGXOEKcIS4S14m7xCPiGfGSeE28Id4S74kPxCfiC/GN6GEQZCGBDLcjdhOHiRPEeeIKcYO4SzwinhIviVfEG+It8Y54T3wkPhNfiR8EgyALCWS4I7GL2E8cJU4SF4irxA3iDvGQeEw8J14Sr4k3xFviHfGe+EB8Ir4Q34geBkEWEsiwJXYQ+4hDxDHiNHGBuExcI24Sd4gHxGPiGfGCeEW8Jt4Qb4l3xHviA/GJ+EJ8I34QPQyCLCSQYWvsJPYRB4nDxHHiFHGOuEhcIa4TN4m7xAPiEfGUeE68JF4Rr4k3xFviHfGe+EB8Ij4TX4nvRA+DIAsJZLgTsZvYSxwgDhFHiePEKeIMcZ64RFwhrhE3iVvEXeI+8ZB4TDwjnhMviVfEa+IN8ZZ4R7wnPhCfiM/EV+I70cMgyEIC+SkIgiAIgiAIgiAIgiAIgiAIgnGH3DOYnp5eI3ZOTk5uEpvElsR6sYbQcLEFsWhkEGQhgQx3J7Q3cZI4Q1wgLhNXiWvEDeIWcYe4TzwkHhNPiefES+IV8Zp4Q7wl3hHviQ/EJ+Iz8ZX4TvQwCLKQQIa7E/uJE8R54jJxjbhJ3CUeEE+J58Qr4jXxjnhPfCQ+E1+JH0QPgyALCWS4B3GEOE1cIC4RV4nrxC3iLvGAeEQ8I14Qr4g3xDviPfGR+Ex8Jb4TPQyCLCSQ4Z7EYeIUcY64SFwhrhE3iNvEPeIh8YR4TrwkXhNviHfEB+IT8YX4RvQwCLKQQIZ7E0eJU8R54hJxhbhO3CLuEveJR8RT4gXxinhDvCPeEx+JT8QX4hvRwyDIQgIZBkEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBMG4o1D4CxA9HkkIS0mHAAAAAElFTkSuQmCC">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBGEs9gyeusEx3y3CSiOYYaH0i4udV7FZE",
            authDomain: "filemimmo-admin.firebaseapp.com",
            projectId: "filemimmo-admin",
            storageBucket: "filemimmo-admin.firebasestorage.app",
            messagingSenderId: "252244376513",
            appId: "1:252244376513:web:f41045e42abab039430d40",
            measurementId: "G-FTEQLN8PZ0"
        };
        try {
            const app = initializeApp(firebaseConfig);
            window.firebaseDb = getFirestore(app);
            window.firebaseDoc = doc;
            window.firebaseSetDoc = setDoc;
            window.firebaseGetDoc = getDoc;
            window.firebaseOnSnapshot = onSnapshot;
            window.firebaseServerTimestamp = serverTimestamp;
            window.firebaseReady = true;
            window.dispatchEvent(new Event('firebaseready'));
            console.log('üî• Firebase SDK caricato con successo');
        } catch (error) {
            console.error('‚ùå Errore inizializzazione Firebase:', error);
            window.firebaseReady = false;
        }
    </script>
    
    <style>
        :root {
            --primary-color: #007aff;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --danger-color: #ff3b30;
            --background-color: #f9f9fb;
            --card-background: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --border-color: #e5e5ea;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 6px 12px rgba(0, 0, 0, 0.1);
            --font-family-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family-apple); background-color: var(--background-color); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        
        .header { background-color: var(--card-background); border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
        .header h1 { text-align: center; font-size: 32px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; letter-spacing: -0.5px; }
        .header-controls { display: flex; gap: 12px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-header { background-color: #f0f0f5; color: var(--text-primary); border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .btn-header:hover { background-color: #e5e5ea; transform: translateY(-1px); }
        
        .sync-status { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; border-radius: 10px; font-size: 14px; font-weight: 500; margin-bottom: 20px; }
        .sync-status.connecting { background-color: #fff8f0; color: var(--warning-color); }
        .sync-status.error { background-color: #ffeeee; color: var(--danger-color); }
        .sync-status.connected { background-color: #eef7ee; color: var(--success-color); }
        .upload-section { background-color: transparent; border-radius: 16px; padding: 24px; border: 2px dashed var(--border-color); text-align: center; transition: all 0.3s ease; }
        .upload-section:hover { border-color: var(--primary-color); }
        .file-label { display: inline-block; background-color: var(--primary-color); color: white; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.2s ease; }
        .file-label:hover { background-color: #0056cc; transform: scale(1.03); }
        .file-input { display: none; }

        .stats, .stats-payment { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px; }
        .stats-payment { padding-top: 20px; border-top: 1px solid #e5e5ea; }
        .stat-card { background-color: var(--card-background); border-radius: 16px; padding: 24px; text-align: left; box-shadow: var(--shadow-light); border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
        .stat-number { font-size: 28px; font-weight: 600; margin-bottom: 6px; }
        .stat-number.danger { color: var(--danger-color); }
        .stat-label { font-size: 15px; font-weight: 500; color: var(--text-secondary); }

        .controls { background-color: var(--card-background); border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
        .search-input { width: 100%; padding: 14px 18px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; background-color: var(--background-color); margin-bottom: 16px; }
        .filters-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
        .filter-select { padding: 14px 18px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; background-color: var(--background-color); cursor: pointer; -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M5%208l5%205%205-5z%22%20fill%3D%22%236e6e73%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.2em; }
        .btn-reset { background: transparent; color: var(--primary-color); border: none; padding: 8px 20px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 500; }
        
        .role-stats { background-color: var(--card-background); border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
        .role-stats-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .role-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .role-stat-item { background-color: #f9f9fb; padding: 16px; border-radius: 12px; border: 1px solid #e5e5ea; }
        .role-stat-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; text-transform: uppercase; }
        .role-stat-list { max-height: 250px; overflow-y: auto; }
        .role-stat-entry { display: flex; justify-content: space-between; padding: 6px 0; font-size: 14px; border-bottom: 1px solid #e5e5ea; }
        .role-stat-entry:last-child { border-bottom: none; }
        .role-stat-name { font-weight: 500; }
        .role-stat-amount { font-weight: 600; color: var(--danger-color); }
        
        .agencies-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .agency-card { background-color: var(--card-background); border-radius: 16px; padding: 20px; box-shadow: var(--shadow-light); border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s ease; position: relative; }
        .agency-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
        .agency-card::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; border-radius: 16px 0 0 16px; transition: background-color 0.3s; }
        .agency-card.payment-rid::before, .agency-card.payment-bonifico::before { background-color: var(--success-color); }
        .agency-card.payment-promessi::before { background-color: var(--warning-color); }
        .agency-card.payment-sospeso::before { background-color: var(--danger-color); }
        .agency-name { font-size: 18px; font-weight: 600; margin-bottom: 8px; padding-right: 120px; }
        .payment-status-dropdown { position: absolute; top: 16px; right: 16px; z-index: 10; }
        .payment-status-select { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; border: 1px solid var(--border-color); cursor: pointer; background-color: #f9f9fb; }
        .agency-info { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6; }
        .agency-info strong { font-weight: 500; color: var(--text-primary); }
        .debt-amount { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .debt-amount.danger { color: var(--danger-color); }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; }
        .status-badges { display: flex; gap: 6px; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; }
        .status-badge.attivo { background-color: #e3f2fd; color: var(--primary-color); }
        .status-badge.sospeso { background-color: #ffeeee; color: var(--danger-color); }
        .status-badge.promessa { background-color: #fff8f0; color: var(--warning-color); }
        .empty-state { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
        .empty-state h3 { font-size: 20px; margin-bottom: 12px; color: var(--text-primary); }
        .notes-summary-section { background-color: var(--card-background); border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
        .notes-summary-title { font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .notes-list { max-height: 300px; overflow-y: auto; }
        .note-item { padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s; position: relative; }
        .note-item:hover { background-color: #f0f0f5; }
        .note-agency { font-weight: 600; margin-bottom: 4px; }
        .note-content { font-size: 14px; color: #3c3c43; margin-bottom: 6px; }
        .note-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-secondary); }
        .note-delete-btn-summary { position: absolute; top: 12px; right: 12px; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; padding: 4px; transition: color 0.2s; z-index: 5; }
        .note-delete-btn-summary:hover { color: var(--danger-color); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--background-color); margin: 3% auto; border-radius: 20px; width: 90%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--card-background); }
        .modal-title { font-size: 22px; font-weight: 600; }
        .close-modal { color: #8e8e93; font-size: 28px; cursor: pointer; background: #f0f0f5; border: none; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s ease; }
        .close-modal:hover { background-color: #e5e5ea; transform: rotate(90deg); }
        .modal-body { flex: 1; overflow-y: auto; padding: 8px; }
        .modal-section { background-color: var(--card-background); padding: 24px; margin: 8px; border-radius: 16px; }
        .modal-section-title { font-size: 17px; font-weight: 600; margin-bottom: 16px; }
        .status-buttons { display: flex; gap: 8px; }
        .status-btn { flex: 1; padding: 12px; border: 2px solid; border-radius: 10px; background-color: var(--card-background); cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease; text-align: center; }
        .status-btn.active { color: white; }
        .status-btn.attivo-pagato { border-color: var(--success-color); color: var(--success-color); }
        .status-btn.attivo-pagato.active { background-color: var(--success-color); }
        .status-btn.attivo-promessa { border-color: var(--warning-color); color: var(--warning-color); }
        .status-btn.attivo-promessa.active { background-color: var(--warning-color); }
        .status-btn.sospeso-insoluto { border-color: var(--danger-color); color: var(--danger-color); }
        .status-btn.sospeso-insoluto.active { background-color: var(--danger-color); }
        .contact-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .contact-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); font-size: 15px; }
        .btn-save { background-color: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease; }
        .btn-save:hover { background-color: #0056cc; }
        .tabs { display: flex; background-color: #f0f0f5; padding: 4px; border-radius: 12px; margin-bottom: 16px; }
        .tab { flex: 1; padding: 10px; background: transparent; border: none; cursor: pointer; font-size: 15px; font-weight: 500; color: var(--text-secondary); border-radius: 9px; transition: all 0.2s ease; }
        .tab.active { color: var(--text-primary); background-color: var(--card-background); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .summary-item { display: flex; flex-direction: column; gap: 8px; }
        .summary-label { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; }
        .summary-value { font-size: 16px; font-weight: 500; }
        .document-item { background-color: #f9f9fb; border-radius: 10px; padding: 16px; margin-bottom: 12px; border: 1px solid #e5e5ea; }
        .document-header { display: flex; justify-content: space-between; align-items: center; }
        .document-title, .document-amount { font-size: 16px; font-weight: 600; }
        .document-amount { color: var(--danger-color); }
        .document-details { font-size: 13px; color: #6e6e73; margin-top: 4px; }
        .note-form { display: grid; gap: 12px; grid-template-areas: 'text text' 'due channels' 'button button'; }
        .notes-textarea { grid-area: text; width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 15px; resize: vertical; }
        .due-date-group { grid-area: due; display: flex; flex-direction: column; gap: 4px; }
        .channel-checkboxes { grid-area: channels; display: flex; flex-direction: column; gap: 4px; }
        .btn-primary { grid-area: button; background: var(--primary-color); color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px; width: 100%; margin-top: 0; }
        .notes-history-list { max-height: 250px; overflow-y: auto; margin-top: 20px; }
        .note-history-item { padding: 12px 0; border-bottom: 1px solid #e5e5ea; position: relative; }
        .note-history-item:last-child { border: none; }
        .note-delete-btn { position: absolute; top: 12px; right: 0; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; }
        .note-delete-btn:hover { color: var(--danger-color); }
        .note-history-meta { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; padding-right: 24px; }
        .note-history-text { font-size: 15px; white-space: pre-wrap; line-height: 1.5; padding-right: 24px; }
        .message-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .message-btn { flex: 1; min-width: 150px; padding: 12px; background-color: #f0f0f5; color: var(--primary-color); border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .message-preview { background-color: #f0f0f5; border-radius: 10px; padding: 16px; margin-top: 16px; white-space: pre-wrap; font-size: 14px; line-height: 1.6; border: 1px solid var(--border-color); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 10px); background: rgba(0,0,0,0.75); color: white; padding: 12px 24px; border-radius: 10px; z-index: 2000; opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; transform: translate(-50%, -20px); }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .agencies-grid, .filters-row, .stats, .stats-payment, .role-stats-grid, .summary-grid { grid-template-columns: 1fr; }
            .contact-grid { grid-template-columns: 1fr 1fr; }
            .modal-content { width: 100%; height: 100%; max-height: 100%; margin: 0; border-radius: 0; }
            .header-controls { flex-direction: column; align-items: stretch; }
            .note-form { grid-template-areas: 'text' 'due' 'channels' 'button'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AdminFilePro</h1>
            <div class="header-controls">
                <button class="btn-header" onclick="exportRoleStats()">üíº Export Dettaglio Insoluti</button>
                <button class="btn-header" onclick="showNotesListModal()">üìã Elenco Note</button>
                <button class="btn-header" onclick="exportSospesi()">üìä Export Sospesi</button>
                <button class="btn-header" onclick="exportPromesse()">üìä Export Promesse</button>
                <button class="btn-header" onclick="manualSync()">üîÑ Sincronizza</button>
                <button class="btn-header" id="saveFirebaseBtn" onclick="saveToFirebase()">üíæ Salva su Firebase</button>
            </div>
            <div id="syncStatus" class="sync-status"></div>
            <div id="fileInfo" style="text-align: center; margin-bottom: 20px; color: var(--text-secondary); font-size: 14px; display: none;"></div>
            <div class="upload-section">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                <label for="fileInput" class="file-label">üìÅ Carica Foglio Excel</label>
                <div id="fileStatus" style="margin-top: 12px; font-size: 14px; color: var(--text-secondary);"></div>
            </div>
        </div>

        <div id="statsSection" style="display: none;"><div class="stats"></div><div class="stats-payment"></div></div>
        <div id="roleStatsSection" class="role-stats" style="display: none;">
            <div class="role-stats-title"><span>üíº</span><span>Insoluti per Ruolo</span></div>
            <div class="role-stats-grid">
                <div class="role-stat-item"><div class="role-stat-label">Consulenti Editoriali</div><div id="statsConsulentiEditoriali" class="role-stat-list"></div></div>
                <div class="role-stat-item"><div class="role-stat-label">Consulenti di Rete</div><div id="statsConsulentiRete" class="role-stat-list"></div></div>
                <div class="role-stat-item"><div class="role-stat-label">Team Manager</div><div id="statsTeamManager" class="role-stat-list"></div></div>
            </div>
        </div>
        <div id="notesSummarySection" class="notes-summary-section" style="display: none;">
            <div class="notes-summary-title">
                <span>üìã</span>
                <span>Ultime Note Inserite</span>
            </div>
            <div id="notesList" class="notes-list"></div>
        </div>
        <div id="controlsSection" class="controls" style="display: none;">
             <input type="text" id="searchInput" class="search-input" placeholder="üîç Cerca agenzia, BDTI, consulente...">
            <div class="filters-row">
                <select id="consultEditoriale" class="filter-select"><option value="">üë§ Tutti i Consulenti Editoriali</option></select>
                <select id="consultRete" class="filter-select"><option value="">üë• Tutti i Consulenti di Rete</option></select>
                <select id="teamManager" class="filter-select"><option value="">üë®‚Äçüíº Tutti i Team Manager</option></select>
            </div>
            <div class="filters-row" style="margin-top: 12px;">
                <select id="affiliatoFilter" class="filter-select"><option value="">üè¢ Tutti gli Affiliati</option></select>
                <select id="paymentStatus" class="filter-select">
                    <option value="">üí≥ Tutti gli Stati Pagamento</option>
                    <option value="rid">üü¢ Pagamenti Regolari (RID)</option>
                    <option value="bonifico">üü¢ Pagamenti Regolari (Bonifico)</option>
                    <option value="promessi">üü† Pagamenti Promessi</option>
                                                    <option value="sospeso">üî¥ PRESospeso</option>
                </select>
                <select id="agencyStatusFilter" class="filter-select">
                    <option value="">üìä Tutti gli Stati Agenzia</option>
                    <option value="attivo-pagato">üü¢ Attivo Pagato</option>
                    <option value="attivo-promessa">üü† Attivo Promessa</option>
                    <option value="sospeso-insoluto">üî¥ Sospeso Insoluto</option>
                </select>
            </div>
            <div id="filterReset" style="display: none; justify-content: center; margin-top: 16px;"><button class="btn-reset" onclick="resetFilters()">üîÑ Reset Filtri</button></div>
        </div>
        <div id="agenciesContainer">
             <div class="empty-state" id="initial-loading-message">
                <h3>üîÑ Caricando dati da Firebase...</h3>
                <p>Se non hai mai caricato un file, clicca "Carica Foglio Excel"</p>
            </div>
        </div>
    </div>

    <div id="agencyModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="modalTitle"></h2><button class="close-modal" onclick="closeModal()">&times;</button></div><div id="modalBody" class="modal-body"></div></div></div>
    <div id="notesListModal" class="modal"><div class="modal-content" style="max-width: 800px;"><div class="modal-header"><h2 class="modal-title">üìã Elenco Note con Scadenza</h2><button class="close-modal" onclick="closeNotesModal()">&times;</button></div><div id="notesListModalBody" class="modal-body"></div></div></div>
    
    <script>
        // GLOBAL STATE & UTILITIES
        let agenciesData = [], editableData = {}, paymentStatuses = {}, agencyStatuses = {}, communicationsHistory = {};
        let filteredAgencies = [];
        let fileInfo = { name: '', loadTime: '' };
        let lastSyncTime = '';
        let firebaseReady = false;

        const F = {
            escapeHtml: (text) => text ? text.toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]) : '',
            updateSyncStatus: (type, message) => { const el = document.getElementById('syncStatus'); if(el) { el.className = `sync-status ${type}`; el.innerHTML = `<span>${message}</span>`; }},
            downloadCSV: (csvContent, fileName) => {
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.setAttribute("download", fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            showToast: (message) => {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('show');
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);
                }, 10);
            },
            // Funzione per creare selettore CSS sicuro
            createSafeSelector: (text) => {
                return text.replace(/[^a-zA-Z0-9]/g, '_');
            }
        };

        // FIREBASE ABSTRACTION
        const FB = {
            async save(docName, data) { 
                if (!firebaseReady) return false;
                try { 
                    await window.firebaseSetDoc(window.firebaseDoc(window.firebaseDb, 'filemimmo', docName), { 
                        data: JSON.stringify(data), 
                        timestamp: window.firebaseServerTimestamp() 
                    }); 
                    return true;
                } catch (e) { 
                    console.error(`Save Error: ${docName}`, e); 
                    return false;
                } 
            },
            async load(docName) { 
                if (!firebaseReady) return null; 
                try { 
                    const snap = await window.firebaseGetDoc(window.firebaseDoc(window.firebaseDb, 'filemimmo', docName)); 
                    return snap.exists() ? JSON.parse(snap.data().data) : null; 
                } catch (e) { 
                    console.error(`Load Error: ${docName}`, e); 
                    return null; 
                } 
            },
            async saveAll() {
                if (!firebaseReady) return false;
                F.updateSyncStatus('connecting', 'üîÑ Sincronizzazione...');
                const results = await Promise.all(Object.entries({ agenciesData, editableData, paymentStatuses, agencyStatuses, communicationsHistory, fileInfo }).map(([k, v]) => FB.save(k, v)));
                const allSaved = results.every(result => result === true);
                if (allSaved) {
                    lastSyncTime = new Date().toLocaleString('it-IT');
                    UI.updateFileInfo();
                    F.updateSyncStatus('connected', '‚úÖ Sincronizzato');
                    return true;
                } else {
                    F.updateSyncStatus('error', '‚ùå Errore sincronizzazione');
                    return false;
                }
            }
        };

        // UI RENDERING
        const UI = {
            updateFileInfo: () => {
                const el = document.getElementById('fileInfo');
                if (fileInfo && fileInfo.name && el) {
                    el.innerHTML = `üìÅ ${F.escapeHtml(fileInfo.name)}&nbsp;&nbsp;|&nbsp;&nbsp;‚è∞ Caricato: ${fileInfo.loadTime}&nbsp;&nbsp;|&nbsp;&nbsp;üîÑ Ultima sincronizzazione: ${lastSyncTime}`;
                    el.style.display = 'block';
                } else {
                    el.style.display = 'none';
                }
            },
            displayStats: () => {
                const data = filteredAgencies.length > 0 ? filteredAgencies : agenciesData;
                const totals = data.reduce((acc, agency) => {
                    acc.insoluti += agency.totalInsoluti; acc.promesse += agency.totalPromesse; acc.debito += agency.totalDebt;
                    acc.payments[paymentStatuses[agency.name] || 'rid'] = (acc.payments[paymentStatuses[agency.name] || 'rid'] || 0) + 1;
                    return acc;
                }, { insoluti: 0, promesse: 0, debito: 0, payments: {} });
                const formatCurrency = (num) => `‚Ç¨${(num || 0).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                document.querySelector('.stats').innerHTML = `<div class="stat-card"><div class="stat-label">Totale Insoluti</div><div class="stat-number danger">${formatCurrency(totals.insoluti)}</div></div> <div class="stat-card"><div class="stat-label">Totale Promesse</div><div class="stat-number warning">${formatCurrency(totals.promesse)}</div></div> <div class="stat-card"><div class="stat-label">Totale Debito</div><div class="stat-number">${formatCurrency(totals.debito)}</div></div>`;
                const regolari = (totals.payments.rid || 0) + (totals.payments.bonifico || 0);
                document.querySelector('.stats-payment').innerHTML = `<div class="stat-card" onclick="filterByPaymentStatus('rid,bonifico')"><div class="stat-label">Agenzie Regolari</div><div class="stat-number success">${regolari}</div></div> <div class="stat-card" onclick="filterByPaymentStatus('promessi')"><div class="stat-label">Agenzie Promesse</div><div class="stat-number warning">${totals.payments.promessi || 0}</div></div> <div class="stat-card" onclick="filterByPaymentStatus('sospeso')"><div class="stat-label">Agenzie Sospese</div><div class="stat-number danger">${totals.payments.sospeso || 0}</div></div>`;
            },
            displayRoleStats: () => {
                const roles = { statsConsulentiEditoriali: {}, statsConsulentiRete: {}, statsTeamManager: {} };
                (filteredAgencies.length > 0 ? filteredAgencies : agenciesData).forEach(agency => {
                    if (agency.totalInsoluti > 0) {
                        const teamManager = agency.teamManager || (editableData[agency.name] && editableData[agency.name].teamManager);
                        if (agency.consultEditoriale) roles.statsConsulentiEditoriali[agency.consultEditoriale] = (roles.statsConsulentiEditoriali[agency.consultEditoriale] || 0) + agency.totalInsoluti;
                        if (agency.consultRete) roles.statsConsulentiRete[agency.consultRete] = (roles.statsConsulentiRete[agency.consultRete] || 0) + agency.totalInsoluti;
                        if (teamManager) roles.statsTeamManager[teamManager] = (roles.statsTeamManager[teamManager] || 0) + agency.totalInsoluti;
                    }
                });
                Object.entries(roles).forEach(([elementId, stats]) => {
                    const container = document.getElementById(elementId);
                    if (!container) return;
                    const sorted = Object.entries(stats).sort((a,b) => b[1] - a[1]);
                    container.innerHTML = sorted.length ? sorted.map(([name, total]) => `<div class="role-stat-entry"><span class="role-stat-name">${F.escapeHtml(name)}</span><span class="role-stat-amount">‚Ç¨${total.toLocaleString('it-IT',{minimumFractionDigits:2})}</span></div>`).join('') : '<div style="text-align:center;color:var(--text-secondary);padding:10px 0;">Nessun insoluto</div>';
                });
            },
            displayAgencies: () => {
                const container = document.getElementById('agenciesContainer');
                const loadingMessage = document.getElementById('initial-loading-message');
                if (loadingMessage) loadingMessage.style.display = 'none';

                if (filteredAgencies.length === 0 && agenciesData.length > 0) { container.innerHTML = `<div class="empty-state"><h3>Nessuna agenzia trovata</h3><p>Prova a modificare i filtri di ricerca</p></div>`; return; }
                const getOrder = (status) => ({'sospeso': 1, 'promessi': 2, 'rid': 3, 'bonifico': 3}[status] || 4);
                filteredAgencies.sort((a, b) => getOrder(paymentStatuses[a.name]) - getOrder(paymentStatuses[b.name]));
                const grid = document.createElement('div');
                grid.className = 'agencies-grid';
                grid.innerHTML = filteredAgencies.map(agency => {
                    const paymentStatus = paymentStatuses[agency.name] || 'rid';
                    const agencyStatus = (agencyStatuses[agency.name] || 'attivo-pagato').split('-')[0];
                    // Crea un ID sicuro per l'agenzia
                    const safeAgencyId = F.createSafeSelector(agency.name);
                    return `
                    <div class="agency-card payment-${paymentStatus}" onclick="showAgencyDetails(agenciesData.find(a => a.name === '${F.escapeHtml(agency.name)}'))">
                        <div class="payment-status-dropdown" onclick="event.stopPropagation()">
                            <select class="payment-status-select" onchange="updatePaymentStatus('${F.escapeHtml(agency.name)}', this.value)">
                                <option value="rid" ${paymentStatus === 'rid' ? 'selected' : ''}>üü¢ RID</option>
                                <option value="bonifico" ${paymentStatus === 'bonifico' ? 'selected' : ''}>üü¢ Bonifico</option>
                                <option value="promessi" ${paymentStatus === 'promessi' ? 'selected' : ''}>üü† Promessi</option>
                                <option value="sospeso" ${paymentStatus === 'sospeso' ? 'selected' : ''}>üî¥ PRESospeso</option>
                            </select>
                        </div>
                        <div class="agency-name">${F.escapeHtml(agency.name)}</div>
                        <div class="agency-info">
                            <div><strong>BDTI:</strong> ${agency.bdti || 'N/A'}</div>
                            ${editableData[agency.name] && editableData[agency.name].affiliato ? `<div><strong>Affiliato:</strong> ${F.escapeHtml(editableData[agency.name].affiliato)}</div>` : ''}
                            <div><strong>C. Editoriale:</strong> ${F.escapeHtml(agency.consultEditoriale) || 'N/A'}</div>
                            <div><strong>C. Rete:</strong> ${F.escapeHtml(agency.consultRete) || 'N/A'}</div>
                        </div>
                        <div class="debt-amount ${agency.totalInsoluti > 0 ? 'danger' : ''}">Insoluto: ‚Ç¨${agency.totalInsoluti.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        <div class="card-footer">
                            <div class="status-badges">
                                <span class="status-badge ${agencyStatus}">${
                                    agencyStatus === 'attivo-pagato' ? 'ATTIVO PAGATO' :
                                    agencyStatus === 'attivo-promessa' ? 'ATTIVO PROMESSA' :
                                    agencyStatus === 'sospeso-insoluto' ? 'SOSPESO INSOLUTO' : 'ATTIVO'
                                }</span>
                                <span class="status-badge attivo">${agency.status || 'N/A'}</span>
                            </div>
                            <span style="font-size:12px;color:var(--text-secondary);">${agency.documents.length} doc.</span>
                        </div>
                    </div>`;
                }).join('');
                container.innerHTML = '';
                container.appendChild(grid);
            },
            displayNotesHistory: (agencyName, isReadOnly = false) => {
                const history = communicationsHistory[agencyName] || [];
                if (history.length === 0) return `<p style="text-align:center;color:var(--text-secondary);padding:20px 0;">${isReadOnly ? 'Nessuna nota presente' : 'Nessuna nota salvata'}</p>`;
                return history.map((note, index) => {
                    const channels = note.channels ? Object.entries(note.channels).filter(([_,v])=>v).map(([k])=>{
                        if(k === 'whatsapp') return 'üí¨';
                        if(k === 'mail') return 'üìß';
                        if(k === 'voce') return 'üìû';
                    }).join(' ') : '';
                    return `<div class="note-history-item" data-note-index="${index}">
                        ${isReadOnly ? '' : `<button class="note-delete-btn" onclick="deleteNoteFromHistory('${F.escapeHtml(agencyName)}', ${index})" title="Elimina">üóëÔ∏è</button>`}
                        <div class="note-history-meta">
                            <span>Creato: ${note.timestamp} ${channels}</span>
                            <span style="font-weight:600;">Scadenza: ${note.scadenza ? new Date(note.scadenza).toLocaleDateString('it-IT') : 'N/A'}</span>
                        </div>
                        <div class="note-history-text">${F.escapeHtml(note.message)}</div>
                    </div>`
                }).join('');
            },
            displayNotesSummary: () => {
                const container = document.getElementById('notesList');
                if (!container) return;

                let allNotes = [];
                Object.entries(communicationsHistory).forEach(([agencyName, notes]) => {
                    notes.forEach((note, index) => allNotes.push({ agencyName, noteIndex: index, ...note }));
                });
                
                allNotes.sort((a,b) => {
                    const dateA = a.timestamp.split(', ')[0].split('/').reverse().join('-');
                    const dateB = b.timestamp.split(', ')[0].split('/').reverse().join('-');
                    return new Date(dateB) - new Date(dateA);
                });
                
                const notesSummarySection = document.getElementById('notesSummarySection');
                if (allNotes.length > 0) {
                    notesSummarySection.style.display = 'block';
                    container.innerHTML = allNotes.slice(0, 5).map(note => {
                        return `
                        <div class="note-item" data-agency-name="${F.escapeHtml(note.agencyName)}" data-note-index="${note.noteIndex}">
                            <button class="note-delete-btn-summary" onclick="deleteNoteFromSummary('${F.escapeHtml(note.agencyName)}', ${note.noteIndex})" title="Elimina nota">üóëÔ∏è</button>
                            <div class="note-content-wrapper" onclick="openAgencyFromNote('${F.escapeHtml(note.agencyName)}')">
                                <div class="note-agency">${F.escapeHtml(note.agencyName)}</div>
                                <div class="note-content">${F.escapeHtml(note.message)}</div>
                                <div class="note-meta">
                                    <div class="note-date">${note.timestamp}</div>
                                </div>
                            </div>
                        </div>`
                    }).join('');
                } else {
                    notesSummarySection.style.display = 'none';
                }
            },
            setupUI: () => {
                populateFilters();
                applyFilters(); 
                UI.displayNotesSummary();
                ['statsSection', 'roleStatsSection', 'controlsSection'].forEach(id => document.getElementById(id).style.display = 'block');
            }
        };

        // DATA & LOGIC
        function populateFilters() {
            const createOptions = (values) => [...new Set(values.filter(Boolean))].sort().map(v => `<option value="${F.escapeHtml(v)}">${F.escapeHtml(v)}</option>`).join('');
            document.getElementById('consultEditoriale').innerHTML = '<option value="">üë§ Tutti i Consulenti Editoriali</option>' + createOptions(agenciesData.map(a => a.consultEditoriale));
            document.getElementById('consultRete').innerHTML = '<option value="">üë• Tutti i Consulenti di Rete</option>' + createOptions(agenciesData.map(a => a.consultRete));
            document.getElementById('teamManager').innerHTML = '<option value="">üë®‚Äçüíº Tutti i Team Manager</option>' + createOptions(agenciesData.map(a => a.teamManager || (editableData[a.name] && editableData[a.name].teamManager)));
            document.getElementById('affiliatoFilter').innerHTML = '<option value="">üè¢ Tutti gli Affiliati</option>' + createOptions(Object.values(editableData).map(d => d.affiliato).filter(Boolean));
        }

        function processFile(file) {
            document.getElementById('fileStatus').textContent = '‚è≥ Caricamento...';
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type: 'array'}).Sheets['Foglio1']);
                    const clientsData = jsonData.filter(row => Object.values(row).some(v => v));
                    if (!clientsData.length) throw new Error("Nessun dato valido nel file");
                    agenciesData = Object.values(clientsData.reduce((acc, row) => {
                        const name = row['Ragione sociale'];
                        if (!name) return acc;
                        if (!acc[name]) acc[name] = { 
                            name, 
                            bdti: row['Bdti'], 
                            consultEditoriale: row['Nome Consulente Editoriale'], 
                            consultRete: row['Nome Consulente'], 
                            teamManager: row['Team Manager'] || row['Team'] || '', 
                            documents: [], totalDebt: 0, totalInsoluti: 0, totalPromesse: 0, 
                            status: row['Sieweb'] 
                        };
                        const doc = {
                            'Documento': row['Documento'],
                            'DEBITO': row['DEBITO'],
                            'INSOLUTI': row['INSOLUTI'],
                            'Data Documento': row['Data Documento'] || row['Data documento'] || row['Data'],
                            'Data Scadenza': row['Data Scadenza'] || row['Data scadenza'] || row['Scadenza'],
                        };
                        acc[name].documents.push(doc);
                        acc[name].totalDebt += parseFloat(row['DEBITO']) || 0;
                        acc[name].totalInsoluti += parseFloat(row['INSOLUTI']) || 0;
                        acc[name].totalPromesse += parseFloat(row['Cifra promessa']) || 0;
                        return acc;
                    }, {}));
                    agenciesData.forEach(agency => {
                        if (!paymentStatuses[agency.name]) paymentStatuses[agency.name] = 'rid';
                        if (!agencyStatuses[agency.name]) agencyStatuses[agency.name] = 'attivo-pagato';
                    });
                    fileInfo = { name: file.name, loadTime: new Date().toLocaleString('it-IT') };
                    filteredAgencies = [...agenciesData];
                    UI.setupUI();
                    FB.saveAll();
                    document.getElementById('fileStatus').textContent = `‚úÖ ${agenciesData.length} agenzie caricate.`;
                } catch (err) { document.getElementById('fileStatus').textContent = `‚ùå ${err.message}`; }
            };
            reader.readAsArrayBuffer(file);
        }

        function applyFilters() {
            const S = Object.fromEntries(['searchInput','consultEditoriale','consultRete','teamManager','affiliatoFilter','paymentStatus','agencyStatusFilter'].map(id=>[id, document.getElementById(id).value]));
            filteredAgencies = agenciesData.filter(agency => {
                const agencyData = editableData[agency.name] || {};
                const teamManager = agency.teamManager || agencyData.teamManager || '';
                const searchString = `${agency.name} ${agency.bdti} ${agency.consultEditoriale} ${agency.consultRete} ${teamManager} ${agencyData.affiliato}`.toLowerCase();
                return (!S.searchInput || searchString.includes(S.searchInput.toLowerCase())) &&
                       (!S.consultEditoriale || agency.consultEditoriale === S.consultEditoriale) &&
                       (!S.consultRete || agency.consultRete === S.consultRete) &&
                       (!S.teamManager || teamManager === S.teamManager) &&
                       (!S.affiliatoFilter || agencyData.affiliato === S.affiliatoFilter) &&
                       (!S.paymentStatus || (paymentStatuses[agency.name] || 'rid') === S.paymentStatus) &&
                       (!S.agencyStatusFilter || (agencyStatuses[agency.name] || 'attivo-pagato') === S.agencyStatusFilter);
            });
            document.getElementById('filterReset').style.display = Object.values(S).some(v => v) ? 'flex' : 'none';
            UI.displayStats(); UI.displayRoleStats(); UI.displayAgencies(); UI.displayNotesSummary();
        }

        function resetFilters() { ['searchInput','consultEditoriale','consultRete','teamManager','affiliatoFilter','paymentStatus','agencyStatusFilter'].forEach(id => document.getElementById(id).value = ''); applyFilters(); }
        
        function showAgencyDetails(agency) {
            document.getElementById('modalTitle').textContent = agency.name;
            const modalBody = document.getElementById('modalBody'), agencyData = editableData[agency.name] || {}, currentStatus = agencyStatuses[agency.name] || 'attivo-pagato';
            const safeAgencyId = F.createSafeSelector(agency.name);
            modalBody.innerHTML = `
                <div class="modal-section"><div class="status-buttons">
                    <button class="status-btn attivo-pagato ${currentStatus === 'attivo-pagato' ? 'active' : ''}" onclick="updateAgencyStatus('${F.escapeHtml(agency.name)}', 'attivo-pagato', this)">üü¢ ATTIVO PAGATO</button>
                    <button class="status-btn attivo-promessa ${currentStatus === 'attivo-promessa' ? 'active' : ''}" onclick="updateAgencyStatus('${F.escapeHtml(agency.name)}', 'attivo-promessa', this)">üü† ATTIVO PROMESSA</button>
                    <button class="status-btn sospeso-insoluto ${currentStatus === 'sospeso-insoluto' ? 'active' : ''}" onclick="updateAgencyStatus('${F.escapeHtml(agency.name)}', 'sospeso-insoluto', this)">üî¥ SOSPESO INSOLUTO</button>
                </div></div>

                <div class="modal-section">
                    <h3 class="modal-section-title">Informazioni Aggiuntive</h3>
                    <div class="contact-grid">
                        <input type="text" class="contact-input" id="affiliato_${safeAgencyId}" placeholder="Affiliato" value="${F.escapeHtml(agencyData.affiliato || '')}" onchange="updateContactData('${F.escapeHtml(agency.name)}')">
                        <input type="text" class="contact-input" id="responsabile_${safeAgencyId}" placeholder="Responsabile" value="${F.escapeHtml(agencyData.responsabile || '')}" onchange="updateContactData('${F.escapeHtml(agency.name)}')">
                        <input type="text" class="contact-input" id="telefono_${safeAgencyId}" placeholder="Telefono" value="${F.escapeHtml(agencyData.telefono || '')}" onchange="updateContactData('${F.escapeHtml(agency.name)}')">
                    </div>
                </div>
                
                <div class="modal-section">
                    <div class="tabs">
                        <button class="tab active" onclick="showTab(this, 'riepilogo_${safeAgencyId}')">Riepilogo</button>
                        <button class="tab" onclick="showTab(this, 'documenti_${safeAgencyId}')">Documenti (${agency.documents.length})</button>
                        <button class="tab" onclick="showTab(this, 'note_${safeAgencyId}')">Note</button>
                    </div>

                    <div id="riepilogo_${safeAgencyId}" class="tab-content active">
                        <div class="summary-grid">
                            <div class="summary-item"><span class="summary-label">BDTI</span><span class="summary-value">${agency.bdti||'N/A'}</span></div>
                            <div class="summary-item"><span class="summary-label">C. Editoriale</span><span class="summary-value">${F.escapeHtml(agency.consultEditoriale)||'N/A'}</span></div>
                            <div class="summary-item"><span class="summary-label">C. Rete</span><span class="summary-value">${F.escapeHtml(agency.consultRete)||'N/A'}</span></div>
                            <div class="summary-item"><span class="summary-label">T. Manager</span><span class="summary-value">${F.escapeHtml(agency.teamManager || agencyData.teamManager)||'N/A'}</span></div>
                            <div class="summary-item"><span class="summary-label">Affiliato</span><span class="summary-value">${F.escapeHtml(agencyData.affiliato)||'N/A'}</span></div>
                            <div class="summary-item"><span class="summary-label">Responsabile</span><span class="summary-value">${F.escapeHtml(agencyData.responsabile)||'N/A'}</span></div>
                            <div class="summary-item"><span class="summary-label">Telefono</span><span class="summary-value">${F.escapeHtml(agencyData.telefono)||'N/A'}</span></div>
                            <div class="summary-item"><span class="summary-label">Totale Debito</span><span class="summary-value">‚Ç¨${agency.totalDebt.toLocaleString('it-IT',{minimumFractionDigits:2})}</span></div>
                            <div class="summary-item"><span class="summary-label">Totale Insoluti</span><span class="summary-value" style="color:var(--danger-color)">‚Ç¨${agency.totalInsoluti.toLocaleString('it-IT',{minimumFractionDigits:2})}</span></div>
                        </div>
                        <h3 class="modal-section-title" style="margin-top: 24px;">Note Inserite</h3>
                        <div class="notes-history-list" style="max-height: 150px;" id="riepilogo_notes_${safeAgencyId}">${UI.displayNotesHistory(agency.name, true)}</div>
                    </div>

                    <div id="documenti_${safeAgencyId}" class="tab-content">${agency.documents.map(doc => `<div class="document-item"><div class="document-header"><div class="document-title">Doc. ${doc['Documento']||'N/A'}</div><div class="document-amount">‚Ç¨${(parseFloat(doc['INSOLUTI'])||0).toLocaleString('it-IT',{minimumFractionDigits:2})}</div></div><div class="document-details">Data: ${doc['Data Documento']||'N/A'} | Scadenza: ${doc['Data Scadenza']||'N/A'}</div></div>`).join('')}</div>
                    
                    <div id="note_${safeAgencyId}" class="tab-content" data-agency-name="${F.escapeHtml(agency.name)}">
                        <h3 class="modal-section-title">Nuova Nota</h3>
                        <div class="note-form">
                            <textarea class="notes-textarea" id="note_text_${safeAgencyId}" placeholder="Aggiungi una nota..."></textarea>
                            <div class="due-date-group">
                                <label for="scadenza_${safeAgencyId}">Data di Scadenza</label>
                                <input type="date" class="contact-input" id="scadenza_${safeAgencyId}">
                            </div>
                            <div class="channel-checkboxes">
                                <label><input type="checkbox" id="channel_whatsapp_${safeAgencyId}" checked> üí¨ WhatsApp</label>
                                <label><input type="checkbox" id="channel_mail_${safeAgencyId}"> üìß Mail</label>
                                <label><input type="checkbox" id="channel_voce_${safeAgencyId}"> üìû Voce</label>
                            </div>
                            <button class="btn-primary" onclick="saveNote('${F.escapeHtml(agency.name)}')">Salva Nota</button>
                        </div>
                        <h3 class="modal-section-title" style="margin-top:24px;">Cronologia Note</h3>
                        <div class="notes-history-list" id="notes_history_${safeAgencyId}">${UI.displayNotesHistory(agency.name, false)}</div>
                    </div>
                </div>
                <div class="modal-section"><h3 class="modal-section-title">Genera Messaggi</h3>
                    <div class="message-buttons">
                        <button class="message-btn" onclick="generateMessage('${F.escapeHtml(agency.name)}', 'situazione')">üìä Situazione Debitoria</button>
                        <button class="message-btn" onclick="generateMessage('${F.escapeHtml(agency.name)}', 'sollecito')">‚ö†Ô∏è Sollecito Sospensione</button>
                        <button class="message-btn" onclick="generateMessage('${F.escapeHtml(agency.name)}', 'sospensione')">üö´ Sospensione</button>
                    </div>
                    <div class="message-preview" id="messagePreview_${safeAgencyId}" style="display:none;"></div>
                    <button class="btn-primary" id="copyMessageBtn_${safeAgencyId}" style="display:none; margin-top: 12px;" onclick="copyMessage('${F.escapeHtml(agency.name)}')">Copia Messaggio</button>
                </div>`;
            document.getElementById('agencyModal').style.display = 'block';
        }
        
        // GLOBAL FUNCTIONS
        window.saveToFirebase = async () => {
            const saveBtn = document.getElementById('saveFirebaseBtn');
            const originalText = saveBtn.innerHTML;
            
            try {
                // Mostra stato di salvataggio
                saveBtn.innerHTML = '‚è≥ Salvando...';
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.6';
                
                F.updateSyncStatus('connecting', 'üîÑ Salvando dati su Firebase...');
                
                // Salva tutti i dati su Firebase
                const savePromises = [
                    FB.save('agenciesData', agenciesData),
                    FB.save('editableData', editableData),
                    FB.save('paymentStatuses', paymentStatuses),
                    FB.save('agencyStatuses', agencyStatuses),
                    FB.save('communicationsHistory', communicationsHistory),
                    FB.save('fileInfo', fileInfo)
                ];
                
                const results = await Promise.all(savePromises);
                const allSaved = results.every(result => result === true);
                
                if (allSaved) {
                    // Successo
                    saveBtn.innerHTML = '‚úÖ Salvato!';
                    saveBtn.style.background = '#34c759';
                    saveBtn.style.color = 'white';
                    F.updateSyncStatus('connected', '‚úÖ Tutti i dati salvati su Firebase');
                    F.showToast('‚úÖ Salvataggio completato con successo');
                    
                    lastSyncTime = new Date().toLocaleString('it-IT');
                    UI.updateFileInfo();
                    
                    // Ripristina il pulsante dopo 2 secondi
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.style.background = '';
                        saveBtn.style.color = '';
                        saveBtn.disabled = false;
                        saveBtn.style.opacity = '1';
                    }, 2000);
                    
                } else {
                    throw new Error('Alcuni dati non sono stati salvati correttamente');
                }
                
            } catch (error) {
                // Errore
                console.error('Errore salvataggio Firebase:', error);
                saveBtn.innerHTML = '‚ùå Errore!';
                saveBtn.style.background = '#ff3b30';
                saveBtn.style.color = 'white';
                F.updateSyncStatus('error', '‚ùå Errore nel salvataggio');
                F.showToast('‚ùå Errore durante il salvataggio');
                
                // Ripristina il pulsante dopo 3 secondi
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.style.color = '';
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                }, 3000);
            }
        };
        window.updatePaymentStatus = (agencyName, status) => { paymentStatuses[agencyName] = status; FB.save('paymentStatuses', paymentStatuses).then(() => applyFilters()); };
        window.updateAgencyStatus = async (agencyName, status, btn) => { 
            agencyStatuses[agencyName] = status; 
            const success = await FB.save('agencyStatuses', agencyStatuses);
            if (success) {
                btn.parentElement.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active')); 
                btn.classList.add('active'); 
                
                // Aggiorna immediatamente lo stato sulla card esterna PRIMA di applyFilters
                updateExternalCardStatus(agencyName, status);
                
                F.showToast('‚úÖ Stato salvato correttamente');
            } else {
                F.showToast('‚ùå Errore nel salvataggio dello stato');
            }
        };
        
        function updateExternalCardStatus(agencyName, status) {
            // Trova la card corrispondente nel DOM
            const agencyCards = document.querySelectorAll('.agency-card');
            agencyCards.forEach(card => {
                const cardTitleElement = card.querySelector('.agency-name');
                if (cardTitleElement && cardTitleElement.textContent.trim() === agencyName) {
                    // Trova il primo badge di stato nella card
                    const statusBadges = card.querySelector('.status-badges');
                    if (statusBadges) {
                        const firstBadge = statusBadges.querySelector('.status-badge:first-child');
                        if (firstBadge) {
                            // Rimuovi tutte le classi di stato precedenti
                            firstBadge.className = 'status-badge';
                            
                            // Aggiungi la nuova classe di stato
                            const statusClass = status.split('-')[0]; // attivo o sospeso
                            firstBadge.classList.add(statusClass);
                            
                            // Aggiorna il testo del badge
                            const statusText = {
                                'attivo-pagato': 'ATTIVO PAGATO',
                                'attivo-promessa': 'ATTIVO PROMESSA', 
                                'sospeso-insoluto': 'SOSPESO INSOLUTO'
                            }[status] || 'ATTIVO';
                            
                            firstBadge.textContent = statusText;
                        }
                    }
                    
                    // Aggiorna anche la classe CSS della card per i colori del bordo
                    card.classList.remove('payment-rid', 'payment-bonifico', 'payment-promessi', 'payment-sospeso');
                    const paymentStatus = paymentStatuses[agencyName] || 'rid';
                    card.classList.add(`payment-${paymentStatus}`);
                }
            });
        }
        window.updateContactData = async (agencyName) => { 
            if (!editableData[agencyName]) editableData[agencyName] = {};
            const safeAgencyId = F.createSafeSelector(agencyName);
            editableData[agencyName].affiliato = document.getElementById(`affiliato_${safeAgencyId}`).value;
            editableData[agencyName].responsabile = document.getElementById(`responsabile_${safeAgencyId}`).value;
            editableData[agencyName].telefono = document.getElementById(`telefono_${safeAgencyId}`).value;
            const success = await FB.save('editableData', editableData);
            if (success) {
                // Aggiorna il riepilogo in tempo reale
                const riepilogoContainer = document.getElementById(`riepilogo_${safeAgencyId}`);
                if (riepilogoContainer) {
                    const summaryGrid = riepilogoContainer.querySelector('.summary-grid');
                    if (summaryGrid) {
                        // Aggiorna i valori nel riepilogo
                        const summaryItems = summaryGrid.querySelectorAll('.summary-item');
                        summaryItems.forEach(item => {
                            const label = item.querySelector('.summary-label').textContent.trim();
                            const valueElement = item.querySelector('.summary-value');
                            if (label === 'Affiliato') {
                                valueElement.textContent = editableData[agencyName].affiliato || 'N/A';
                            } else if (label === 'Responsabile') {
                                valueElement.textContent = editableData[agencyName].responsabile || 'N/A';
                            } else if (label === 'Telefono') {
                                valueElement.textContent = editableData[agencyName].telefono || 'N/A';
                            }
                        });
                    }
                }
                populateFilters(); // Ricarica i filtri per mostrare i nuovi dati
                applyFilters(); // Riapplica i filtri
                F.showToast('‚úÖ Dati salvati correttamente');
            } else {
                F.showToast('‚ùå Errore nel salvataggio');
            }
        };
        
        window.saveNote = (agencyName) => { 
            const safeAgencyId = F.createSafeSelector(agencyName);
            const noteText = document.getElementById(`note_text_${safeAgencyId}`).value.trim();
            if (!noteText) return F.showToast('‚ö†Ô∏è Inserisci una nota');
            const newNote = {
                message: noteText,
                timestamp: new Date().toLocaleString('it-IT'),
                scadenza: document.getElementById(`scadenza_${safeAgencyId}`).value,
                channels: {
                    whatsapp: document.getElementById(`channel_whatsapp_${safeAgencyId}`).checked,
                    mail: document.getElementById(`channel_mail_${safeAgencyId}`).checked,
                    voce: document.getElementById(`channel_voce_${safeAgencyId}`).checked
                }
            };
            if (!communicationsHistory[agencyName]) communicationsHistory[agencyName] = [];
            communicationsHistory[agencyName].unshift(newNote); 
            FB.save('communicationsHistory', communicationsHistory).then(() => {
                // Aggiorna entrambe le sezioni note
                const notesHistoryContainer = document.getElementById(`notes_history_${safeAgencyId}`);
                if (notesHistoryContainer) {
                    notesHistoryContainer.innerHTML = UI.displayNotesHistory(agencyName, false);
                }
                const riepilogoNotesContainer = document.getElementById(`riepilogo_notes_${safeAgencyId}`);
                if (riepilogoNotesContainer) {
                    riepilogoNotesContainer.innerHTML = UI.displayNotesHistory(agencyName, true);
                }
                UI.displayNotesSummary();
                document.getElementById(`note_text_${safeAgencyId}`).value = '';
                F.showToast('‚úÖ Nota salvata con successo');
            });
        };
        
        window.deleteNoteFromHistory = async (agencyName, noteIndex) => {
            if (!confirm('Sei sicuro di voler eliminare questa nota?')) return;
            
            if (communicationsHistory[agencyName] && communicationsHistory[agencyName][noteIndex]) {
                communicationsHistory[agencyName].splice(noteIndex, 1);
                const success = await FB.save('communicationsHistory', communicationsHistory);
                if (success) {
                    const safeAgencyId = F.createSafeSelector(agencyName);
                    // Aggiorna entrambe le sezioni note
                    const notesHistoryContainer = document.getElementById(`notes_history_${safeAgencyId}`);
                    if (notesHistoryContainer) {
                        notesHistoryContainer.innerHTML = UI.displayNotesHistory(agencyName, false);
                    }
                    const riepilogoNotesContainer = document.getElementById(`riepilogo_notes_${safeAgencyId}`);
                    if (riepilogoNotesContainer) {
                        riepilogoNotesContainer.innerHTML = UI.displayNotesHistory(agencyName, true);
                    }
                    UI.displayNotesSummary();
                    F.showToast('üóëÔ∏è Nota eliminata');
                } else {
                    F.showToast('‚ùå Errore nell\'eliminazione della nota');
                }
            }
        };
        
        window.deleteNoteFromSummary = async (agencyName, noteIndex) => {
            if (!confirm('Sei sicuro di voler eliminare questa nota?')) return;
            
            if (communicationsHistory[agencyName] && communicationsHistory[agencyName][noteIndex]) {
                communicationsHistory[agencyName].splice(noteIndex, 1);
                const success = await FB.save('communicationsHistory', communicationsHistory);
                if (success) {
                    UI.displayNotesSummary();
                    F.showToast('üóëÔ∏è Nota eliminata');
                } else {
                    F.showToast('‚ùå Errore nell\'eliminazione della nota');
                }
            }
        };

        window.showTab = (btn, tabId) => { const p = btn.closest('.modal-section'); p.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); p.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(tabId).classList.add('active'); };
        window.generateMessage = (agencyName, type) => {
            const agency = agenciesData.find(a => a.name === agencyName); if (!agency) return;
            let documentsText = agency.documents.map(doc => `‚Ä¢ Doc. ${doc['Documento'] || 'N/A'} del ${doc['Data Documento'] || 'N/A'} - ‚Ç¨ ${(parseFloat(doc['DEBITO']) || 0).toLocaleString('it-IT')}`).join('\n');
            const messages = {
                situazione: `${agency.bdti} ${agency.name},\nti inoltro la Tua situazione aggiornata:\n\n**INSOLUTO ATTUALE (${new Date().toLocaleDateString('it-IT')}):\n‚Ä¢ Debito totale: ‚Ç¨${agency.totalDebt.toLocaleString('it-IT')}\n‚Ä¢ Insoluti: ‚Ç¨${agency.totalInsoluti.toLocaleString('it-IT')}**\n\nSCADENZE:\n${documentsText}\n\nFammi sapere!!\nGrazie e buon lavoro.`,
                sollecito: `Ciao l'amministrazione ti ha scritto in merito all'insoluto una mail con il dettaglio del dovuto\n*Cliente:* ${agency.name}\n*Codice BDTI:* ${agency.bdti}\n*Dettaglio documenti scaduti:*\n${documentsText}\n*TOTALE DEBITO: ‚Ç¨ ${agency.totalDebt.toLocaleString('it-IT')}*\nMi fai sapere come regolarci per il saldo!! Se non mi dai riscontro a breve scatta la sospensione definitiva.\nGrazie e buon lavoro.`,
                sospensione: `Ciao *Cliente:* ${agency.name}\n*Codice BDTI:* ${agency.bdti}\n*Dettaglio documenti scaduti:*\n${documentsText}\n*TOTALE DEBITO: ‚Ç¨ ${agency.totalDebt.toLocaleString('it-IT')}*\nTi Informo del saldo e che non avendo ricevuto riscontro sei stato SOSPESO da ADV.\nResto a Tua disposizione per qualsiasi ulteriore informazione e per concordare il rientro del dovuto.\nGrazie e buon lavoro.`
            };
            const safeAgencyId = F.createSafeSelector(agencyName);
            const preview = document.getElementById(`messagePreview_${safeAgencyId}`);
            const copyBtn = document.getElementById(`copyMessageBtn_${safeAgencyId}`);
            preview.textContent = messages[type] || "Messaggio non disponibile.";
            preview.style.display = 'block';
            copyBtn.style.display = 'block';
        };
        window.copyMessage = (agencyName) => {
            const safeAgencyId = F.createSafeSelector(agencyName);
            const textToCopy = document.getElementById(`messagePreview_${safeAgencyId}`).textContent;
            navigator.clipboard.writeText(textToCopy).then(() => F.showToast('‚úÖ Messaggio copiato!'));
        };
        window.exportRoleStats = () => {
            const dataToExport = filteredAgencies.length > 0 ? filteredAgencies : agenciesData;
            if (dataToExport.length === 0) return F.showToast('‚ö†Ô∏è Nessun dato da esportare');
            const headers = "Ragione Sociale;Codice BDTI;Consulente Editoriale;Consulente di Rete;Team Manager;Importo Insoluto\n";
            let total = 0;
            const rows = dataToExport.filter(a => a.totalInsoluti > 0).map(agency => {
                total += agency.totalInsoluti;
                const teamManager = agency.teamManager || (editableData[agency.name] && editableData[agency.name].teamManager) || '';
                return `"${agency.name}";"${agency.bdti}";"${agency.consultEditoriale || ''}";"${agency.consultRete || ''}";"${teamManager}";"${agency.totalInsoluti.toFixed(2).replace('.',',')}"`;
            });
            const footer = `\n;;;;TOTALE GENERALE;${total.toFixed(2).replace('.',',')}`;
            F.downloadCSV(headers + rows.join('\n') + footer, `dettaglio_insoluti.csv`);
        };
        window.exportSospesi = () => {
            const dataToExport = filteredAgencies.length > 0 ? filteredAgencies : agenciesData;
            const sospesi = dataToExport.filter(a => paymentStatuses[a.name] === 'sospeso');
            if (sospesi.length === 0) return F.showToast('‚ö†Ô∏è Nessuna agenzia sospesa da esportare');
            let csv = "Ragione Sociale;BDTI;Insoluto\n";
            sospesi.forEach(a => { csv += `"${a.name}";"${a.bdti}";"${a.totalInsoluti.toFixed(2).replace('.',',')}"\n`; });
            F.downloadCSV(csv, 'agenzie_sospese.csv');
        };
        window.exportPromesse = () => {
            const dataToExport = filteredAgencies.length > 0 ? filteredAgencies : agenciesData;
            const promesse = dataToExport.filter(a => paymentStatuses[a.name] === 'promessi');
            if (promesse.length === 0) return F.showToast('‚ö†Ô∏è Nessuna agenzia con promesse da esportare');
            let csv = "Ragione Sociale;BDTI;Insoluto\n";
            promesse.forEach(a => { csv += `"${a.name}";"${a.bdti}";"${a.totalInsoluti.toFixed(2).replace('.',',')}"\n`; });
            F.downloadCSV(csv, 'agenzie_promesse.csv');
        };
        window.showNotesListModal = () => {
            const modal = document.getElementById('notesListModal');
            const body = document.getElementById('notesListModalBody');
            let allNotes = [];
            Object.entries(communicationsHistory).forEach(([agencyName, notes]) => {
                notes.forEach(note => { if(note.scadenza) allNotes.push({ agencyName, ...note }); });
            });
            allNotes.sort((a, b) => new Date(a.scadenza) - new Date(b.scadenza));
            
            if (allNotes.length === 0) {
                body.innerHTML = '<div class="empty-state"><h3>Nessuna nota con data di scadenza.</h3><p>Puoi aggiungere una scadenza alle note dalla scheda di dettaglio di un\'agenzia.</p></div>';
            } else {
                body.innerHTML = `<div style="padding: 8px;">${allNotes.map(note => {
                    return `<div class="document-item" style="cursor:pointer" onclick="openAgencyFromNote('${F.escapeHtml(note.agencyName)}')">
                        <div class="document-header">
                            <div class="document-title">${F.escapeHtml(note.agencyName)}</div>
                            <div style="font-weight:600; color: var(--danger-color);">Scadenza: ${new Date(note.scadenza).toLocaleDateString('it-IT')}</div>
                        </div>
                        <div class="document-details">${F.escapeHtml(note.message)}</div>
                    </div>`
                }).join('')}</div>`;
            }
            modal.style.display = 'block';
        };
        window.manualSync = () => { FB.saveAll(); };
        window.closeModal = () => document.getElementById('agencyModal').style.display = 'none';
        window.closeNotesModal = () => document.getElementById('notesListModal').style.display = 'none';
        window.resetFilters = resetFilters;
        window.openAgencyFromNote = (agencyName) => {
            closeNotesModal();
            const agency = agenciesData.find(a => a.name === agencyName);
            if(agency) showAgencyDetails(agency);
        };
        
        // APP INITIALIZATION
        document.addEventListener('DOMContentLoaded', async () => {
            F.updateSyncStatus('connecting', 'üîÑ Inizializzazione...');
            const firebaseReadyPromise = new Promise(resolve => {
                if(window.firebaseReady) resolve(true);
                else window.addEventListener('firebaseready', () => resolve(true));
            });
            firebaseReady = await firebaseReadyPromise;

            if (!firebaseReady) { F.updateSyncStatus('error', '‚ùå Connessione a Firebase fallita'); return; }

            try {
                F.updateSyncStatus('connected', 'üî• Connesso. Carico dati...');
                const dataMap = await Promise.all([FB.load('agenciesData'), FB.load('editableData'), FB.load('paymentStatuses'), FB.load('agencyStatuses'), FB.load('communicationsHistory'), FB.load('fileInfo')]);
                [agenciesData, editableData, paymentStatuses, agencyStatuses, communicationsHistory, fileInfo] = dataMap.map(d => d || (d === null ? {} : (Array.isArray(d) ? [] : d)));
                
                if (agenciesData && agenciesData.length > 0) {
                    filteredAgencies = [...agenciesData];
                    lastSyncTime = new Date().toLocaleString('it-IT');
                    UI.setupUI();
                    UI.updateFileInfo();
                    F.updateSyncStatus('connected', `‚úÖ Dati aggiornati da Firebase`);
                } else {
                    F.updateSyncStatus('connected', 'üî• Pronto. Carica un file Excel.');
                }
            } catch (error) {
                console.error("Errore nel caricamento dati:", error);
                F.updateSyncStatus('error', '‚ùå Errore caricamento dati.');
            }
            
            ['consultEditoriale','consultRete','teamManager','affiliatoFilter','paymentStatus','agencyStatusFilter'].forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('fileInput').addEventListener('change', (e) => e.target.files[0] && processFile(e.target.files[0]));
        });
    </script>
</body>
</html>